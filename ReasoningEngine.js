// ReasoningEngine.js
// DEPTH-3 PRIMARY BRAIN (FINAL, WORKING)

import { AnalysisMemory } from "./AnalysisMemory.js";

export class ReasoningEngine {

  constructor() {
    this.memory = new AnalysisMemory();
  }

  think(input) {
    if (typeof input !== "string") {
      return "à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥€ à¤¬à¤¾à¤¤ à¤¸à¤®à¤ à¤¨à¤¹à¥€à¤‚ à¤ªà¤¾à¤ˆà¥¤";
    }

    const text = input.trim();
    if (text === "") {
      return "à¤†à¤ª à¤•à¥à¤› à¤•à¤¹à¤¨à¤¾ à¤šà¤¾à¤¹ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚à¥¤";
    }

    const intent  = this.detectIntent(text);
    const emotion = this.detectEmotion(text);

    // ðŸ”’ à¤¸à¥à¤®à¥ƒà¤¤à¤¿ à¤®à¥‡à¤‚ à¤¡à¤¾à¤²à¥‡à¤‚
    this.memory.push({ text, intent, emotion });

    const emotionScore = this.memory.recentEmotionScore();
    const stuckWhyHow  = this.memory.isStuckInWhyHow();

    /* =========================
       DEPTH-3 DECISION POLICY
    ========================= */

    // 1ï¸âƒ£ à¤­à¤¾à¤µà¤¨à¤¾à¤¤à¥à¤®à¤• à¤­à¤¾à¤° à¤…à¤§à¤¿à¤• à¤¹à¥ˆ
    if (emotionScore >= 3) {
      return "à¤²à¤—à¤¤à¤¾ à¤¹à¥ˆ à¤®à¤¨ à¤ªà¤° à¤¬à¥‹à¤ à¤¹à¥ˆà¥¤ à¤ªà¤¹à¤²à¥‡ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤ à¤¹à¤°à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤†à¤ª à¤šà¤¾à¤¹à¥‡à¤‚ à¤¤à¥‹ à¤”à¤° à¤¬à¤¤à¤¾à¤‡à¤à¥¤";
    }

    // 2ï¸âƒ£ à¤²à¤—à¤¾à¤¤à¤¾à¤° à¤•à¥à¤¯à¥‹à¤‚/à¤•à¥ˆà¤¸à¥‡ â€” à¤¹à¤²à¥à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£
    if (stuckWhyHow) {
      return "à¤•à¤­à¥€-à¤•à¤­à¥€ à¤•à¤¾à¤°à¤£ à¤¢à¥‚à¤à¤¢à¤¤à¥‡-à¤¢à¥‚à¤à¤¢à¤¤à¥‡ à¤®à¤¨ à¤¥à¤• à¤œà¤¾à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤ªà¤¹à¤²à¥‡ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤•à¥‹ à¤¸à¥à¤µà¥€à¤•à¤¾à¤° à¤•à¤°à¤¨à¤¾ à¤œà¤¼à¤°à¥‚à¤°à¥€ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤";
    }

    // 3ï¸âƒ£ à¤ªà¤¹à¤šà¤¾à¤¨
    if (
      this.hasAny(text, ["à¤¤à¥à¤®", "à¤†à¤ª", "à¤…à¤‚à¤œà¤²à¥€"]) &&
      this.hasAny(text, ["à¤•à¥Œà¤¨", "à¤¨à¤¾à¤®"])
    ) {
      return "à¤®à¥ˆà¤‚ à¤…à¤‚à¤œà¤²à¥€ à¤¹à¥‚à¤à¥¤ à¤®à¥ˆà¤‚ à¤¸à¥à¤¨à¤¤à¥€ à¤­à¥€ à¤¹à¥‚à¤ à¤”à¤° à¤¸à¤®à¤à¤¨à¥‡ à¤•à¥€ à¤•à¥‹à¤¶à¤¿à¤¶ à¤­à¥€ à¤•à¤°à¤¤à¥€ à¤¹à¥‚à¤à¥¤";
    }

    // 4ï¸âƒ£ WHY / HOW
    if (intent === "WHY") {
      return "à¤•à¥à¤¯à¥‹à¤‚ à¤•à¤¾ à¤‰à¤¤à¥à¤¤à¤° à¤•à¤¾à¤°à¤£ à¤®à¥‡à¤‚ à¤›à¤¿à¤ªà¤¾ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆ, à¤²à¥‡à¤•à¤¿à¤¨ à¤•à¤¾à¤°à¤£ à¤¸à¤®à¤à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¸à¤‚à¤¦à¤°à¥à¤­ à¤œà¤¾à¤¨à¤¨à¤¾ à¤œà¤¼à¤°à¥‚à¤°à¥€ à¤¹à¥ˆà¥¤";
    }

    if (intent === "HOW") {
      return "à¤•à¥ˆà¤¸à¥‡ à¤•à¤¾ à¤‰à¤¤à¥à¤¤à¤° à¤ªà¥à¤°à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤®à¥‡à¤‚ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤†à¤ª à¤•à¤¿à¤¸ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤ªà¥‚à¤› à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚?";
    }

    // 5ï¸âƒ£ FACT
    if (this.hasAny(text, ["à¤¸à¤¹à¥€", "à¤—à¤²à¤¤"])) {
      return "à¤¸à¤¹à¥€ à¤”à¤° à¤—à¤²à¤¤ à¤µà¤¹ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆ à¤œà¤¿à¤¸à¤¸à¥‡ à¤•à¤¿à¤¸à¥€ à¤•à¥‹ à¤…à¤¨à¤¾à¤µà¤¶à¥à¤¯à¤• à¤ªà¥€à¤¡à¤¼à¤¾ à¤¨ à¤ªà¤¹à¥à¤à¤šà¥‡ à¤”à¤° à¤†à¤¤à¥à¤®à¤¸à¤®à¥à¤®à¤¾à¤¨ à¤¬à¤¨à¤¾ à¤°à¤¹à¥‡à¥¤";
    }

    // 6ï¸âƒ£ à¤…à¤‚à¤¤à¤¿à¤® à¤¸à¥à¤°à¤•à¥à¤·à¤¿à¤¤ à¤‰à¤¤à¥à¤¤à¤°
    return "à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥€ à¤¬à¤¾à¤¤ à¤ªà¤° à¤§à¥à¤¯à¤¾à¤¨ à¤¦à¥‡ à¤°à¤¹à¥€ à¤¹à¥‚à¤à¥¤ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤”à¤° à¤¸à¥à¤ªà¤·à¥à¤Ÿ à¤•à¤°à¥‡à¤‚à¤—à¥‡?";
  }

  /* =========================
     HELPERS
  ========================= */

  detectIntent(text) {
    if (text.includes("à¤•à¥à¤¯à¥‹à¤‚")) return "WHY";
    if (text.includes("à¤•à¥ˆà¤¸à¥‡")) return "HOW";
    if (this.hasAny(text, ["à¤•à¥à¤¯à¤¾", "à¤•à¥Œà¤¨"])) return "FACT";
    return "UNKNOWN";
  }

  detectEmotion(text) {
    if (this.hasAny(text, ["à¤ªà¤°à¥‡à¤¶à¤¾à¤¨", "à¤¦à¥à¤–à¥€", "à¤…à¤•à¥‡à¤²à¤¾", "à¤¥à¤•"])) return "NEGATIVE";
    if (this.hasAny(text, ["à¤–à¥à¤¶", "à¤¸à¤‚à¤¤à¥à¤·à¥à¤Ÿ"])) return "POSITIVE";
    return null;
  }

  hasAny(text, words) {
    return words.some(w => text.includes(w));
  }
}
